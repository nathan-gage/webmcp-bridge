"use strict";

(() => {
  // Nonce is generated by content-main.js and stored in dataset.
  // Read it lazily inside handlers so we don't depend on script ordering.
  function getNonce() {
    return document.documentElement.dataset.webmcpNonce;
  }

  // Relay messages from MAIN world → background service worker
  window.addEventListener("message", (event) => {
    if (event.origin !== window.location.origin) return;
    const nonce = getNonce();
    if (!nonce || !event.data || event.data.nonce !== nonce) return;
    if (event.data.source !== "webmcp-main") return;

    const { nonce: _, source, ...payload } = event.data;
    try {
      chrome.runtime.sendMessage(payload);
    } catch (err) {
      console.warn("[webmcp] sendMessage failed:", err.message);
    }
  });

  // Relay messages from background → MAIN world
  chrome.runtime.onMessage.addListener((message) => {
    const nonce = getNonce();
    if (!nonce) return;
    window.postMessage({ ...message, source: "webmcp-isolated", nonce }, window.location.origin);
  });
})();
